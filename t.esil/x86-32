#!/bin/sh

# GPL 3+ - Copyright (C) 2015  pancake

for a in . .. ../.. ; do [ -e $a/tests.sh ] && . $a/tests.sh ; done

NAME='2step push x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
.aer*
"wa mov eax, 0x1234;push eax"
2aes
.aer*
aer?esp
?v [esp]
'
EXPECT='0x00107ffc
0x1234
'
run_test

NAME='movsb 1 byte x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 12 @ 0x10000000
aeim 0x20000000 10 destination
aer edi=0x20000000
aer esi=0x10000000
.aer*
"wx a4"
2aes
.aer*
aer?edi
aer?esi
pv @0x20000000
'
EXPECT='0x20000001
0x10000001
0x12
'
run_test

NAME='mov eax, 1 x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
.aer*
"wx b801000000"
1aes
.aer*
aer?eax
'
EXPECT='0x00000001
'
run_test

NAME='rep movsb string x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 1234567890 @ 0x10000000
aeim 0x20000000 10 destination
aer edi=0x20000000
aer esi=0x10000000
aer ecx=10
.aer*
"wx f3a4"
aes
.aer*
aer?edi
aer?esi
pv @0x20000000
aer?ecx
'
EXPECT='0x2000000a
0x1000000a
0x78563412
0x00000000
'
run_test

NAME='mov byte [0x20000000], 0x64 x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
wx 1234567890 @ 0x10000000
aeim 0x20000000 10 destination
.aer*
"wx c6050000002064"
aes
.aer*
pv @0x20000000
'
EXPECT='0x64
'
run_test

NAME='mov eax, [esp + 4] x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x20000000 10 destination
aer esp=0x20000000
wx 3713 @ 0x20000004
.aer*
"wx 8b442404"
aes
.aer*
aer?eax
'
EXPECT='0x00001337
'
run_test

NAME='mov [esp + 4], eax x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x20000000 10 destination
aer esp=0x20000000
aer eax=0x1337
.aer*
"wx 89442404"
aes
.aer*
pv @ 0x20000004
'
EXPECT='0x1337
'
run_test

NAME='rep movsb 0x1000 randombytes x86-32'
BROKEN=1
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 0x1000 source
aeim 0x20000000 0x1000 destination
wr 0x1000 @ 0x10000000
aer edi=0x20000000
aer esi=0x10000000
aer ecx=0x1000
.aer*
"wx f3a4"
aes
.aer*
s 0x10000000
cX 0x20000000
aer?edi
aer?esi
aer?ecx
'
EXPECT='0x20001000
0x10001000
0x00000000
'
run_test

NAME='lodsb ++ x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 12 @ 0x10000000
aer esi=0x10000000
.aer*
"wx fcac"
2aes
.aer*
aer?esi
aer?al
'
EXPECT='0x10000001
0x00000012
'
run_test

NAME='lodsb -- x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 12 @ 0x10000000
aer esi=0x10000000
.aer*
"wx fdac"
2aes
.aer*
aer?esi
aer?al
'
EXPECT='0x0fffffff
0x00000012
'
run_test

NAME='lodsw ++ x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 3412 @ 0x10000000
aer esi=0x10000000
.aer*
"wx fc66ad"
2aes
.aer*
aer?esi
aer?ax
'
EXPECT='0x10000002
0x00001234
'
run_test

NAME='lodsw -- x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 3412 @ 0x10000000
aer esi=0x10000000
.aer*
"wx fd66ad"
2aes
.aer*
aer?esi
aer?ax
'
EXPECT='0x0ffffffe
0x00001234
'
run_test

NAME='lodsd ++ x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 563412 @ 0x10000000
aer esi=0x10000000
.aer*
"wx fcad"
2aes
.aer*
aer?esi
aer?eax
'
EXPECT='0x10000004
0x00123456
'
run_test

NAME='lodsd -- x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
wx 563412 @ 0x10000000
aer esi=0x10000000
.aer*
"wx fdad"
2aes
.aer*
aer?esi
aer?eax
'
EXPECT='0x0ffffffc
0x00123456
'
run_test

NAME='stosb ++ x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer al=0x12
aer edi=0x10000000
.aer*
"wx fcaa"
2aes
.aer*
aer?edi
pv @0x10000000
'
EXPECT='0x10000001
0x12
'
run_test

NAME='stosb -- x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer al=0x12
aer edi=0x10000000
.aer*
"wx fdaa"
2aes
.aer*
aer?edi
pv @0x10000000
'
EXPECT='0x0fffffff
0x12
'
run_test

NAME='stosw ++ x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer ax = 0x1234
aer edi=0x10000000
.aer*
"wx fc66ab"
2aes
.aer*
aer?edi
pv @0x10000000
'
EXPECT='0x10000002
0x1234
'
run_test

NAME='stosw -- x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer ax = 0x1234
aer edi=0x10000000
.aer*
"wx fd66ab"
2aes
.aer*
aer?edi
pv @0x10000000
'
EXPECT='0x0ffffffe
0x1234
'
run_test

NAME='stosd ++ x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer eax = 0x123456
aer edi=0x10000000
.aer*
"wx fcab"
2aes
.aer*
aer?edi
pv @0x10000000
'
EXPECT='0x10000004
0x123456
'
run_test

NAME='stosd -- x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer eax = 0x123456
aer edi=0x10000000
.aer*
"wx fdab"
2aes
.aer*
aer?edi
pv @0x10000000
'
EXPECT='0x0ffffffc
0x123456
'
run_test

NAME='shr eax(9) >> 1 x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer eax = 9
aer edi=0x10000000
.aer*
"wx d1e8"
1aes
.aer*
aer?eax
aer?cf
'
EXPECT='0x00000004
0x00000001
'
run_test

NAME='shr eax(0x1b) >> 1 x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer eax = 0x1b
aer edi=0x10000000
.aer*
"wx d1e8"
1aes
.aer*
aer?eax
aer?cf
'
EXPECT='0x0000000d
0x00000001
'
run_test

NAME='shr eax(5) >> 2 x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aeim 0x10000000 10 source
aer eax = 5
aer edi=0x10000000
.aer*
"wx c1e802"
1aes
.aer*
aer?eax
aer?cf
'
EXPECT='0x00000001
0x00000000
'
run_test

NAME='shr byte [esp + 4], 2 x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x10000000 10 source
aer esp=0x10000000
wx 05 @ 0x10000004
.aer*
"wx c06c240402"
1aes
.aer*
pv @ 0x10000004
aer?cf
'
EXPECT='0x1
0x00000000
'
run_test

NAME='add byte [esp + 4], 0xa x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x20000000 10 destination
aer esp=0x20000000
wx ff @ 0x20000004
.aer*
"wx 804424040a"
aes
.aer*
pv @ 0x20000004
aer?cf
'
EXPECT='0x9
0x00000001
'
run_test

NAME='add eax, [esp + 4] x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x20000000 10 destination
aer esp=0x20000000
wx 3713 @ 0x20000004
.aer*
"wx 03442404"
aes
.aer*
aer?eax
'
EXPECT='0x00001337
'
run_test

NAME='add dword [0x20000000], eax x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x20000000 10 destination
aer esp=0x20000000
aer eax=0x1337
.aer*
"wx 010500000020"
aes
.aer*
pv @ 0x20000000
'
EXPECT='0x1337
'
run_test

NAME='add byte cf,zf check  x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aer dl = 0x80
.aer*
"wx 00d2"
1aes
.aer*
aer?dl
aer?cf
aer?zf
'
EXPECT='0x00000000
0x00000001
0x00000001
'
run_test

NAME='add word cf,zf check  x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aer dx = 0x8000
.aer*
"wx 6601d2"
1aes
.aer*
aer?dx
aer?cf
aer?zf
'
EXPECT='0x00000000
0x00000001
0x00000001
'
run_test

NAME='add dword cf,zf check  x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aer edx = 0x80000000
.aer*
"wx 01d2"
1aes
.aer*
aer?edx
aer?cf
aer?zf
'
EXPECT='0x00000000
0x00000001
0x00000001
'
run_test

NAME='adc byte cf,zf check  x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer cf=1
aer esp=0x00108000
aer dl = 0x80
.aer*
"wx 10d2"
1aes
.aer*
aer?dl
aer?cf
aer?zf
'
EXPECT='0x00000001
0x00000001
0x00000000
'
run_test

NAME='adc word cf,zf check  x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer cf=1
aer esp=0x00108000
aer dx = 0x8000
.aer*
"wx 6611d2"
1aes
.aer*
aer?dx
aer?cf
aer?zf
'
EXPECT='0x00000001
0x00000001
0x00000000
'
run_test

NAME='adc dword cf,zf check  x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer cf=1
aer esp=0x00108000
aer edx = 0x80000000
.aer*
"wx 11d2"
1aes
.aer*
aer?edx
aer?cf
aer?zf
'
EXPECT='0x00000001
0x00000001
0x00000000
'
run_test

NAME='dec byte [edi] check zf x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer cf=1
aer esp=0x00108000
aeim 0x20000000 10 mem
aer edi = 0x20000000
wx 01 @ 0x20000000
.aer*
"wx fe0f"
1aes
.aer*
aer?zf
pv @ 0x20000000
'
EXPECT='0x00000001
0x0
'
run_test

NAME='dec byte [edi] check sf x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer cf=1
aer esp=0x00108000
aeim 0x20000000 10 mem
aer edi = 0x20000000
wx 00 @ 0x20000000
.aer*
"wx fe0f"
1aes
.aer*
aer?sf
pv @ 0x20000000
'
EXPECT='0x00000001
0xff
'
run_test

NAME='inc byte [edi] check zf x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer sf=1
aer esp=0x00108000
aeim 0x20000000 10 mem
aer edi = 0x20000000
wx ff @ 0x20000000
.aer*
"wx fe07"
1aes
.aer*
aer?zf
aer?sf
pv @ 0x20000000
'
EXPECT='0x00000001
0x00000000
0x0
'
run_test

NAME='inc byte [edi] check sf x86-32'
FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer sf=1
aer esp=0x00108000
aeim 0x20000000 10 mem
aer edi = 0x20000000
wx 00 @ 0x20000000
.aer*
"wx fe07"
1aes
.aer*
aer?sf
pv @ 0x20000000
'
EXPECT='0x00000000
0x1
'
run_test

NAME='adc [esi + 0x14], ecx x86-32'

FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aeim 0x20000000 130 destination
aer cf = 1
aer ecx = 0x10
aer esi=0x20000000
wx 3713 @ 0x20000014
.aer*
"wx 114e14"
aes
.aer*
pv @ 0x20000014
'
EXPECT='0x1348
'
run_test

NAME='pushal(pushad in intel documentation) x86_32'

FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer eax=0x11111111
aer ecx=0x22222222
aer edx=0x33333333
aer ebx=0x44444444
aer esp=0x00108000
aer ebp=0x55555555
aer esi=0x66666666
aer edi=0x77777777
.aer*
"wx 60"
aes
.aer*
pv @ 0x00107ffc
pv @ 0x00107ff8
pv @ 0x00107ff4
pv @ 0x00107ff0
pv @ 0x00107fec
pv @ 0x00107fe8
pv @ 0x00107fe4
pv @ 0x00107fe0
'
EXPECT='0x11111111
0x22222222
0x33333333
0x44444444
0x108000
0x55555555
0x66666666
0x77777777
'
run_test

NAME='popal(popad in intel documentation) x86_32'

FILE=-
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer eax=0x11111111
aer ecx=0x22222222
aer edx=0x33333333
aer ebx=0x44444444
aer esp=0x00108000
aer ebp=0x55555555
aer esi=0x66666666
aer edi=0x77777777
.aer*
"wx 6061"
aes
.aer*
aer eax=0x00000000
aer ecx=0x00000000
aer edx=0x00000000
aer ebx=0x00000000
aer ebp=0x00000000
aer esi=0x00000000
aer edi=0x00000000
.aer*
aes
.aer*
aer?eax
aer?ecx
aer?edx
aer?ebx
aer?esp
aer?ebp
aer?esi
aer?edi
.aer*
'
EXPECT='0x11111111
0x22222222
0x33333333
0x44444444
0x00108000
0x55555555
0x66666666
0x77777777
'
run_test

NAME='pop x86-32'
FILE=-
BROKEN=
ARGS=
CMDS='
e esil.debug=true
e asm.arch=x86
e asm.bits=32
aei
aeim
aer esp=0x00108000
aer eax=0x11111111
.aer*
"wx 5058"
aes
.aer*
aer eax=0x00000000
.aer*
aes
.aer*
aer?eax
aer?esp
.aer*
'
EXPECT='0x11111111
0x00108000
'
run_test
